---
- ansible.builtin.debug:
    msg: START connection={{ ansible_connection }}/configure.yaml

- name: setup
  cisco.nxos.nxos_config: &teardown
    lines:
      - no feature bgp
      - no feature fabric forwarding
    match: none

- name: enable bgp
  register: result
  cisco.nxos.nxos_feature:
    feature: bgp
    state: enabled

- ansible.builtin.assert:
    that:
      - result.changed == true

- name: verify bgp
  register: result
  cisco.nxos.nxos_feature:
    feature: bgp
    state: enabled

- ansible.builtin.assert:
    that:
      - result.changed == false

- name: disable bgp
  register: result
  cisco.nxos.nxos_feature:
    feature: bgp
    state: disabled

- ansible.builtin.assert:
    that:
      - result.changed == true

- name: verify bgp
  register: result
  cisco.nxos.nxos_feature:
    feature: bgp
    state: disabled

- ansible.builtin.assert:
    that:
      - result.changed == false

- name: verify fabric forwarding
  register: result
  cisco.nxos.nxos_feature:
    feature: fabric forwarding
    state: enabled

- ansible.builtin.assert:
    that:
      - result.changed == True
      - "'feature fabric forwarding' in result.commands"

- name: verify fabric forwarding (IDEMPOTENT)
  register: result
  cisco.nxos.nxos_feature:
    feature: fabric forwarding
    state: enabled

- ansible.builtin.assert:
    that:
      - result.changed == False

- name: verify fabric forwarding disable
  register: result
  cisco.nxos.nxos_feature:
    feature: fabric forwarding
    state: disabled

- ansible.builtin.assert:
    that:
      - result.changed == True
      - "'no feature fabric forwarding' in result.commands"

- name: verify fabric forwarding disabled (IDEMPOTENT)
  register: result
  cisco.nxos.nxos_feature:
    feature: fabric forwarding
    state: disabled

- ansible.builtin.assert:
    that:
      - result.changed == False

- name: teardown
  cisco.nxos.nxos_config: *teardown

- ansible.builtin.debug:
    msg: END connection={{ ansible_connection }}/configure.yaml
