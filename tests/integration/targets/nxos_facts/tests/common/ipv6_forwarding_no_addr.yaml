---
- ansible.builtin.debug:
    msg: START connection={{ ansible_connection }}/ipv6_forwarding_no_addr.yaml

- name: Setup - Remove VLAN configuration
  ignore_errors: true
  cisco.nxos.nxos_config:
    lines:
      - no interface Vlan100
      - no vlan 100

- block:
    - name: Create VLAN 100
      cisco.nxos.nxos_vlans:
        config:
          - vlan_id: 100
            name: test_vlan

    - name: Create VLAN interface
      cisco.nxos.nxos_interfaces:
        config:
          - name: Vlan100
            enabled: true

    - name: Enable IPv6 on VLAN interface (without assigning address)
      cisco.nxos.nxos_config:
        lines:
          - ipv6 enable
        parents:
          - interface Vlan100

    - name: Gather interface facts - should not crash with KeyError
      cisco.nxos.nxos_facts:
        gather_subset:
          - "interfaces"

    - name: Assert that Vlan100 interface exists in facts
      ansible.builtin.assert:
        that:
          - ansible_net_interfaces is defined
          - >-
            'Vlan100' in ansible_net_interfaces or
            'vlan100' in ansible_net_interfaces
        fail_msg: "Vlan100 interface not found in facts"
        success_msg: >-
          Facts gathered successfully for VLAN interface with IPv6 enabled

    - name: Test with both IPv6 forwarding and an interface with address
      cisco.nxos.nxos_config:
        lines:
          - ipv6 address 2001:db8:100::1/64
        parents:
          - interface Vlan100

    - name: Gather interface facts again with IPv6 address present
      cisco.nxos.nxos_facts:
        gather_subset:
          - "interfaces"

    - name: Assert that IPv6 address was found
      ansible.builtin.assert:
        that:
          - "'2001:db8:100::1/64' in ansible_net_all_ipv6_addresses"
        fail_msg: "IPv6 address not found in all_ipv6_addresses"
        success_msg: "IPv6 address correctly detected"

    - name: Remove IPv6 address (keep IPv6 enabled)
      cisco.nxos.nxos_config:
        lines:
          - no ipv6 address 2001:db8:100::1/64
        parents:
          - interface Vlan100

    - name: Gather interface facts after removing address - should not crash
      cisco.nxos.nxos_facts:
        gather_subset:
          - "interfaces"

    - name: Assert interface exists but without IPv6 address
      ansible.builtin.assert:
        that:
          - ansible_net_interfaces is defined
          - >-
            'Vlan100' in ansible_net_interfaces or
            'vlan100' in ansible_net_interfaces
          - "'2001:db8:100::1/64' not in ansible_net_all_ipv6_addresses"
        fail_msg: >-
          Failed to handle interface with IPv6 enabled but no address
        success_msg: >-
          Successfully handled IPv6 enabled interface without address

  always:
    - name: Teardown - Remove VLAN configuration
      ignore_errors: true
      cisco.nxos.nxos_config:
        lines:
          - no interface Vlan100
          - no vlan 100

- ansible.builtin.debug:
    msg: END connection={{ ansible_connection }}/ipv6_forwarding_no_addr.yaml
