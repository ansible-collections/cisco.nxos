---
- ansible.builtin.debug:
    msg: START connection={{ ansible_connection }}/ipv6_forwarding_no_addr.yaml

- name: Setup - Remove VLAN configuration
  ignore_errors: true
  cisco.nxos.nxos_config:
    lines:
      - no interface Vlan100
      - no vlan 100

- block:
    - name: Enable interface-vlan feature
      cisco.nxos.nxos_feature:
        feature: interface-vlan
        state: enabled

    - name: Create VLAN 100
      cisco.nxos.nxos_vlans:
        config:
          - vlan_id: 100
            name: test_vlan

    - name: Create VLAN interface
      cisco.nxos.nxos_interfaces:
        config:
          - name: Vlan100
            enabled: true

    - name: Enable IPv6 forward on VLAN interface (without assigning address)
      cisco.nxos.nxos_config:
        lines:
          - ipv6 forward
        parents:
          - interface Vlan100

    - name: Gather interface facts - should not crash with KeyError
      cisco.nxos.nxos_facts:
        gather_subset:
          - "interfaces"

    - name: Assert that Vlan100 interface exists in facts
      ansible.builtin.assert:
        that:
          - ansible_net_interfaces is defined
          - >-
            'Vlan100' in ansible_net_interfaces or
            'vlan100' in ansible_net_interfaces
        fail_msg: "Vlan100 interface not found in facts"
        success_msg: >-
          Facts gathered successfully for VLAN interface with IPv6 enabled
  always:
    - name: Teardown - Remove VLAN configuration
      ignore_errors: true
      cisco.nxos.nxos_config:
        lines:
          - no interface Vlan100
          - no vlan 100

- ansible.builtin.debug:
    msg: END connection={{ ansible_connection }}/ipv6_forwarding_no_addr.yaml
