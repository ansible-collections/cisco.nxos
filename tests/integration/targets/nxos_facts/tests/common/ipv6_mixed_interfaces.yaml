---
- ansible.builtin.debug:
    msg: START connection={{ ansible_connection }}/ipv6_mixed_interfaces.yaml

- name: Setup - Clean up test VLANs and interfaces
  ignore_errors: true
  cisco.nxos.nxos_config:
    lines:
      - no interface Vlan101
      - no interface Vlan102
      - no vlan 101
      - no vlan 102

- block:
    - name: Enable interface-vlan feature
      cisco.nxos.nxos_feature:
        feature: interface-vlan
        state: enabled

    - name: Create test VLANs
      cisco.nxos.nxos_vlans:
        config:
          - vlan_id: 101
            name: test_vlan_with_addr
          - vlan_id: 102
            name: test_vlan_no_addr

    - name: Create VLAN interfaces
      cisco.nxos.nxos_interfaces:
        config:
          - name: Vlan101
            enabled: true
          - name: Vlan102
            enabled: true

    - name: Configure Vlan101 with IPv6 address
      cisco.nxos.nxos_config:
        lines:
          - ipv6 address 2001:db8:101::1/64
        parents:
          - interface Vlan101

    - name: Configure Vlan102 with IPv6 forwarding enabled but no address
      cisco.nxos.nxos_config:
        lines:
          - ipv6 forward
        parents:
          - interface Vlan102

    - name: Gather facts with mixed IPv6 configuration - should not crash
      cisco.nxos.nxos_facts:
        gather_subset:
          - "interfaces"

    - name: Assert that both interfaces are present
      ansible.builtin.assert:
        that:
          - ansible_net_interfaces is defined
          - >-
            'Vlan101' in ansible_net_interfaces or
            'vlan101' in ansible_net_interfaces
          - >-
            'Vlan102' in ansible_net_interfaces or
            'vlan102' in ansible_net_interfaces
        fail_msg: "Not all VLAN interfaces found in facts"

    - name: Assert that only Vlan101 address is in all_ipv6_addresses
      ansible.builtin.assert:
        that:
          - "'2001:db8:101::1/64' in ansible_net_all_ipv6_addresses"
        fail_msg: "Vlan101 IPv6 address not found"

    - name: Display all IPv6 addresses for debugging
      ansible.builtin.debug:
        var: ansible_net_all_ipv6_addresses

    - name: Remove IPv6 forward and add IPv6 address to Vlan102
      cisco.nxos.nxos_config:
        lines:
          - no ipv6 forward
          - ipv6 address 2001:db8:102::1/64
        parents:
          - interface Vlan102

    - name: Wait for configuration to be applied
      ansible.builtin.pause:
        seconds: 3

    - name: Gather facts again
      cisco.nxos.nxos_facts:
        gather_subset:
          - "interfaces"


    - name: Assert that both IPv6 addresses are present
      ansible.builtin.assert:
        that:
          - "'2001:db8:101::1/64' in ansible_net_all_ipv6_addresses"
          - "'2001:db8:102::1/64' in ansible_net_all_ipv6_addresses"
        fail_msg: "Not all IPv6 addresses found. Got: {{ ansible_net_all_ipv6_addresses }}"
        success_msg: "Successfully handled multiple VLAN interfaces with IPv6"

  always:
    - name: Teardown - Clean up test VLANs and interfaces
      ignore_errors: true
      cisco.nxos.nxos_config:
        lines:
          - no interface Vlan101
          - no interface Vlan102
          - no vlan 101
          - no vlan 102

- ansible.builtin.debug:
    msg: END connection={{ ansible_connection }}/ipv6_mixed_interfaces.yaml
