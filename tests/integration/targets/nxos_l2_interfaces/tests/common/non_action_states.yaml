---
- ansible.builtin.debug:
    msg: Start nxos_l2_interfaces non action states integration tests connection={{ ansible_connection }}

- ansible.builtin.include_tasks: _remove_config.yaml

- ansible.builtin.include_tasks: _populate_config.yaml

- block:
    - name: Parsed - convert running config to structured data
      register: result
      cisco.nxos.nxos_l2_interfaces:
        running_config: |
          interface Ethernet1/800
            switchport access vlan 18
            switchport trunk allowed vlan 210
          interface Ethernet1/801
            switchport trunk allowed vlan 2,4,15
          interface Ethernet1/802
            switchport mode dot1q-tunnel
          interface Ethernet1/803
            switchport mode fex-fabric
          interface Ethernet1/804
            switchport mode fabricpath
        state: parsed

    - ansible.builtin.assert:
        that:
          - parsed | symmetric_difference(result['parsed']) | length == 0

    - name: Rendered - convert config to device commands without applying
      register: result
      cisco.nxos.nxos_l2_interfaces:
        config:
          - name: Ethernet1/1
            trunk:
              native_vlan: 10
              allowed_vlans: 2,4,15
          - name: Ethernet1/2
            access:
              vlan: 30
          - name: Ethernet1/3
            trunk:
              native_vlan: 20
              allowed_vlans: 5-10,15
          - name: Ethernet1/4
            mode: fex-fabric
          - name: Ethernet1/5
            mode: fabricpath
        state: rendered

    - ansible.builtin.assert:
        that:
          - rendered | symmetric_difference(result['rendered']) | length == 0

    - name: Gather pre-facts - for it to assert of gather state
      cisco.nxos.nxos_facts:
        gather_subset:
          - "!all"
          - "!min"
        gather_network_resources: l2_interfaces

    - name: Gathered - Verify rendered state did not change device config
      register: result
      cisco.nxos.nxos_l2_interfaces:
        state: gathered

    - ansible.builtin.assert:
        that:
          - result['gathered'] | symmetric_difference(ansible_facts.network_resources.l2_interfaces) == []

    - name: Deleted - remove context, no granular deletion (delete context of entire interface for l2)
      register: result
      cisco.nxos.nxos_l2_interfaces:
        config:
          - name: Ethernet1/7
          - name: Ethernet1/8
        state: deleted
  always:
    - name: Teardown - reset interfaces
      ignore_errors: true
      cisco.nxos.nxos_config:
        lines:
          - "default interface Ethernet1/7"
          - "default interface Ethernet1/8"
