---
- ansible.builtin.debug:
    msg: Start nxos_l2_interfaces rendered integration tests connection={{ ansible_connection }}

- ansible.builtin.include_tasks: _remove_config.yaml

- name: Gather pre-facts
  cisco.nxos.nxos_facts:
    gather_subset:
      - '!all'
      - '!min'
    gather_network_resources: l2_interfaces

- block:
    - name: Rendered - convert config to device commands without applying
      register: result
      cisco.nxos.nxos_l2_interfaces:
        config:
          - name: Ethernet1/1
            trunk:
              native_vlan: 10
              allowed_vlans: 2,4,15
          - name: Ethernet1/2
            access:
              vlan: 30
          - name: Ethernet1/3
            trunk:
              native_vlan: 20
              allowed_vlans: 5-10,15
          - name: Ethernet1/4
            mode: fex-fabric
          - name: Ethernet1/5
            mode: fabricpath
        state: rendered

    - ansible.builtin.assert:
        that:
          - rendered | symmetric_difference(result['rendered']) | length == 0

    - name: Verify rendered state did not change device config
      register: result
      cisco.nxos.nxos_l2_interfaces:
        state: gathered

    - ansible.builtin.assert:
        that:
          - result['gathered'] | symmetric_difference(ansible_facts.network_resources.l2_interfaces) == []

  always:
    - ansible.builtin.include_tasks: _remove_config.yaml

- ansible.builtin.debug:
    msg: End nxos_l2_interfaces rendered integration tests connection={{ ansible_connection }}
