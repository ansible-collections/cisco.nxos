---
- name: Get vrf data
  cisco.nxos.nxos_command:
    commands: show running | section '^vrf'
  register: result

- name: Check CI machine # Check if CI machine is being used as CI machine does not support some attributes
  cisco.nxos.nxos_config:
    lines:
      - ip multicast multipath legacy
    parents: "vrf context check"
  register: result_check
  ignore_errors: true

- name: Set check fact
  ansible.builtin.set_fact:
    isci: result_check.failed

- name: Remove CI check config
  cisco.nxos.nxos_config:
    lines:
      - no vrf context check
  ignore_errors: true

- name: Set management fact
  ansible.builtin.set_fact:
    management:
      - ip:
          route:
            - destination: "{{ result.stdout[0] | regex_search('ip route [0-9.]+/[0-9]+ ([0-9.]+)', '\\1') | first }}"
              source: "{{ result.stdout[0] | regex_search('ip route ([0-9.]+/[0-9]+)', '\\1') | first }}"
        name: management

- name: Main task for vrf_global module
  ansible.builtin.include_tasks: cli.yaml
  tags:
    - network_cli
